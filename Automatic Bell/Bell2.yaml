substitutions:
  name: esp-web-tools-example-de04c7
  friendly_name: Atal Lab

packages:
  esphome.esp_web_tools_example: github://esphome/example-configs/esp-web-tools/esp8266.yaml@main

esphome:
  name: ${name}
  name_add_mac_suffix: false
  friendly_name: ${friendly_name}
  on_boot:
    priority: -100
    then:
      - switch.turn_on: autoBell

# âš¡ OPTIMIZATION 1: Reduce logger size (significant savings)
logger:
  level: WARN

api:
  encryption:
    key: TF/6Mqoy6I5ldh726u2dACBHL4SYuRvTwB7sQTKNang=
  reboot_timeout: 0s

# â”€â”€â”€ GLOBAL VARIABLES â”€â”€â”€
globals:
  - id: is_siren_running
    type: bool
    restore_value: no
    initial_value: "false"

# â”€â”€â”€ USER INTERFACE COMPONENTS â”€â”€â”€

# 1. Slider to set Manual Siren Duration (1 to 10 mins)
number:
  - platform: template
    name: "Siren Duration (Minutes)"
    id: siren_duration
    optimistic: true
    min_value: 1
    max_value: 10
    step: 1
    initial_value: 1
    mode: slider
    icon: "mdi:timer-sand"

# 2. Switches for Bell Mode and Modes
switch:
  - platform: template
    name: "Auto Bell"
    id: autoBell
    icon: "mdi:bell-ring-outline"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

  - platform: template
    name: "Winter Mode"
    id: winterMode
    icon: "mdi:snowflake"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - logger.log: "Winter Timings Activated"
    turn_off_action:
      - logger.log: "Summer Timings Activated"

  - platform: output
    name: "Bell"
    id: atalLabBell
    output: BellOutput

# 3. Button to manually trigger the Siren
button:
  - platform: template
    name: "Trigger Manual Siren"
    id: btn_manual_siren
    icon: "mdi:bullhorn"
    on_press:
      - script.execute: script_manual_siren

# â”€â”€â”€ HARDWARE OUTPUTS â”€â”€â”€
output:
  - platform: gpio
    id: BellOutput
    pin: GPIO5
    inverted: true

  - platform: gpio
    id: lightOutput
    pin: GPIO4
    inverted: true

light:
  - platform: binary
    name: Light
    id: atalLabLight
    output: lightOutput

# â”€â”€â”€ SENSORS & INPUTS â”€â”€â”€
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO12
      inverted: true
      mode:
        input: true
        pullup: true
    id: lightSwitch
    on_press:
      - light.turn_on: atalLabLight
    on_release:
      - light.turn_off: atalLabLight

  - platform: gpio
    pin:
      number: GPIO3
      inverted: true
      mode:
        input: true
        pullup: true
    id: BellSwitch
    on_press:
      - switch.turn_on: atalLabBell
    on_release:
      - switch.turn_off: atalLabBell

  - platform: gpio
    pin: GPIO14
    name: "Motion Sensor"
    device_class: motion

sensor:
  - platform: dht
    pin: GPIO13
    temperature:
      name: "Atal Tinkering Lab Temperature"
    humidity:
      name: "Atal Tinkering Lab Humidity"
    # âš¡ OPTIMIZATION 2: Reduced polling interval
    update_interval: 30s

# â”€â”€â”€ LOGIC SCRIPTS â”€â”€â”€
script:
  # Standard Short Bell (3s)
  - id: ring_short_bell
    then:
      - switch.turn_on: atalLabBell
      - delay: 3s
      - switch.turn_off: atalLabBell

  # Standard Long Bell (5s)
  - id: ring_long_bell
    then:
      - switch.turn_on: atalLabBell
      - delay: 5s
      - switch.turn_off: atalLabBell

  # ğŸš¨ Manual Siren Logic
  - id: script_manual_siren
    mode: restart
    then:
      - if:
          condition:
            lambda: "return id(is_siren_running);"
          then:
            # STOP COMMAND
            - logger.log: "Siren already running, stopping..."
            - script.stop: script_mock_drill
            - globals.set:
                id: is_siren_running
                value: "false"
            - switch.turn_off: atalLabBell
          else:
            # START COMMAND
            - globals.set:
                id: is_siren_running
                value: "true"
            - logger.log: "Starting Manual Siren..."
            - repeat:
                count: !lambda "return id(siren_duration).state * 30;"
                then:
                  - switch.turn_on: atalLabBell
                  - delay: 1s
                  - switch.turn_off: atalLabBell
                  - delay: 1s
            - globals.set:
                id: is_siren_running
                value: "false"

  # ğŸš¨ Monthly Mock Drill Logic (Fixed 3 Minutes)
  - id: script_mock_drill
    mode: restart
    then:
      - logger.log: "STARTING MONTHLY MOCK DRILL"
      - globals.set:
          id: is_siren_running
          value: "true"
      - repeat:
          count: 90
          then:
            - switch.turn_on: atalLabBell
            - delay: 1s
            - switch.turn_off: atalLabBell
            - delay: 1s
      - globals.set:
          id: is_siren_running
          value: "false"
      - logger.log: "MOCK DRILL COMPLETE"

# â”€â”€â”€ TIME SCHEDULE â”€â”€â”€
time:
  - platform: sntp
    id: sntp_time
    timezone: Asia/Kolkata

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸš¨ MONTHLY RANDOM DRILL TRIGGER
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    on_time:
      - cron: "0 0 10 15 * *"
        then:
          - if:
              condition:
                switch.is_on: autoBell
              then:
                - delay: !lambda "return (random() % 120) * 60000;"
                - script.execute: script_mock_drill

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # â„ï¸ WINTER TIMINGS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Staff Reporting (8:15 AM) - LONG
      - seconds: 0
        minutes: 15
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_long_bell

      # 2. Student Reporting (8:20 AM) - LONG
      - seconds: 0
        minutes: 20
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_long_bell

      # 3. Assembly Bell (8:25 AM) - LONG
      - seconds: 0
        minutes: 25
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_long_bell

      # 4. Assembly Time Start (8:30 AM) - LONG
      - seconds: 0
        minutes: 30
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_long_bell

      # 5. Class Teacher Period (8:45 AM) - LONG
      - seconds: 0
        minutes: 45
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_long_bell

      # 6. Period I (9:00 AM) - SHORT
      - seconds: 0
        minutes: 0
        hours: 9
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_short_bell

      # 7. Period II (9:35 AM) - SHORT
      - seconds: 0
        minutes: 35
        hours: 9
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_short_bell

      # 8. Period III (10:10 AM) - SHORT
      - seconds: 0
        minutes: 10
        hours: 10
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_short_bell

      # 9. Period IV (10:45 AM) - SHORT
      - seconds: 0
        minutes: 45
        hours: 10
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_short_bell

      # 10. Lunch Break (11:25 AM) - LONG
      - seconds: 0
        minutes: 25
        hours: 11
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_long_bell

      # 11. Second Attendance (11:50 AM) - LONG
      - seconds: 0
        minutes: 50
        hours: 11
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_long_bell

      # 12. Period V (12:00 PM) - SHORT
      - seconds: 0
        minutes: 0
        hours: 12
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_short_bell

      # 13. Period VI (12:40 PM) - SHORT
      - seconds: 0
        minutes: 40
        hours: 12
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_short_bell

      # 14. Period VII (1:20 PM / 13:20) - SHORT
      - seconds: 0
        minutes: 20
        hours: 13
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_short_bell

      # 15. Period VIII (2:00 PM / 14:00) - SHORT
      - seconds: 0
        minutes: 0
        hours: 14
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_short_bell

      # 16. School End (2:40 PM / 14:40) - LONG
      - seconds: 0
        minutes: 40
        hours: 14
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
              then:
                - script.execute: ring_long_bell

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # â˜€ï¸ SUMMER TIMINGS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      # Long Bells (Summer)
      - seconds: 0
        minutes: 55
        hours: 7
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_long_bell

      - seconds: 0
        minutes: 55
        hours: 10
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_long_bell

      - seconds: 0
        minutes: 10
        hours: 14
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_long_bell

      # Short Bells (Summer)
      - seconds: 0
        minutes: 15
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 55
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 35
        hours: 9
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 15
        hours: 10
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 25
        hours: 11
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 30
        hours: 11
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 10
        hours: 12
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 50
        hours: 12
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 30
        hours: 13
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
              then:
                - script.execute: ring_short_bell

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
