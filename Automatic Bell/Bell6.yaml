substitutions:
  name: esp-web-tools-example-de04c7
  friendly_name: Atal Lab

packages:
  esphome.esp_web_tools_example: github://esphome/example-configs/esp-web-tools/esp8266.yaml@main

esphome:
  name: ${name}
  name_add_mac_suffix: false
  friendly_name: ${friendly_name}
  on_boot:
    priority: -100
    then:
      - switch.turn_on: autoBell
      - switch.turn_on: winterMode

logger:
  level: WARN

api:
  encryption:
    key: BL9Dooo5Kdx4kFrc6SmO039s8bIxjIvdZF0oJsYsUZM=
  reboot_timeout: 0s

# ─── GLOBAL VARIABLES ───
globals:
  - id: is_siren_running
    type: bool
    restore_value: no
    initial_value: "false"

  - id: last_drill_month
    type: int
    restore_value: true
    initial_value: "0"

  - id: is_exam_mode
    type: bool
    restore_value: yes
    initial_value: "false"

  - id: is_security_mode
    type: bool
    restore_value: yes
    initial_value: "false"

# ─── USER INTERFACE COMPONENTS ───
number:
  - platform: template
    name: "Siren Duration (Minutes)"
    id: siren_duration
    optimistic: true
    min_value: 0
    max_value: 10
    step: 1
    initial_value: 1
    mode: slider
    icon: "mdi:timer-sand"

  - platform: template
    name: "Siren Duration (Seconds)"
    id: siren_duration_seconds
    optimistic: true
    min_value: 0
    max_value: 60 # Max 1 minutes (60 seconds)
    step: 1
    initial_value: 30
    mode: slider
    icon: "mdi:timer-outline"

switch:
  - platform: template
    name: "Auto Bell"
    id: autoBell
    icon: "mdi:bell-ring-outline"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF

  - platform: template
    name: "Winter Mode"
    id: winterMode
    icon: "mdi:snowflake"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - logger.log: "Winter Timings Activated"
    turn_off_action:
      - logger.log: "Summer Timings Activated"

  # EXAM MODE SWITCH
  - platform: template
    name: "Exam Mode"
    id: examModeSwitch
    icon: "mdi:school"
    lambda: |-
      return id(is_exam_mode);
    turn_on_action:
      - globals.set:
          id: is_exam_mode
          value: "true"
      - logger.log: "Exam Mode Enabled"
    turn_off_action:
      - globals.set:
          id: is_exam_mode
          value: "false"
      - logger.log: "Exam Mode Disabled"

  # SECURITY MODE SWITCH
  - platform: template
    name: "Night Security"
    id: securityModeSwitch
    icon: "mdi:shield-lock"
    lambda: |-
      return id(is_security_mode);
    turn_on_action:
      - globals.set:
          id: is_security_mode
          value: "true"
      - logger.log: "Night Security ENABLED"
    turn_off_action:
      - globals.set:
          id: is_security_mode
          value: "false"
      - logger.log: "Night Security DISABLED"

  - platform: template
    name: "Manual Siren"
    id: manualSirenSwitch
    icon: "mdi:bullhorn"
    optimistic: true
    turn_on_action:
      - script.execute: script_manual_siren
    turn_off_action:
      - if:
          condition:
            lambda: "return id(is_siren_running);"
          then:
            - script.execute: script_manual_siren

  - platform: template
    name: "Demo Mode"
    id: demoMode
    icon: "mdi:test-tube"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    turn_on_action:
      - logger.log: "Demo Mode Enabled"
    turn_off_action:
      - logger.log: "Demo Mode Disabled"

  # Switch to Enable/Disable Motion Activated Light logic
  - platform: template
    name: "Motion Light Feature"
    id: motionLightEnabled
    icon: "mdi:motion-sensor"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON # Default to ON after restart
    turn_on_action:
      - logger.log: "Motion Activated Light ENABLED"
    turn_off_action:
      - logger.log: "Motion Activated Light DISABLED"

  - platform: output
    name: "Bell"
    id: atalLabBell
    output: BellOutput

# ─── HARDWARE OUTPUTS ───
output:
  - platform: gpio
    id: BellOutput
    pin: GPIO5
    inverted: true

  - platform: gpio
    id: lightOutput
    pin: GPIO4
    inverted: true

light:
  - platform: binary
    name: Light
    id: atalLabLight
    output: lightOutput

# ─── SENSORS ───

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO12
      inverted: true
      mode:
        input: true
        pullup: true
    id: lightSwitch
    on_press:
      - light.turn_on: atalLabLight
      - script.stop: light_off_timer
    on_release:
      - light.turn_off: atalLabLight

  - platform: gpio
    pin:
      number: GPIO3
      inverted: true
      mode:
        input: true
        pullup: true
    id: BellSwitch
    on_press:
      - switch.turn_on: atalLabBell
    on_release:
      - switch.turn_off: atalLabBell

  - platform: gpio
    pin: GPIO14
    name: "Motion Sensor"
    device_class: motion
    id: motion_sensor
    on_press:
      then:
        # 1. LIGHT LOGIC:
        # Turn Light ON if "Motion Feature" is Enabled OR "Security Mode" is Active
        - if:
            condition:
              lambda: "return id(motionLightEnabled).state || id(is_security_mode);"
            then:
              - light.turn_on: atalLabLight
              # Stop any pending "off" timer so light stays on while moving
              - script.stop: light_off_timer

        # 2. SECURITY ALARM LOGIC:
        # Ring bell only if Security Mode is Active
        - if:
            condition:
              lambda: "return id(is_security_mode);"
            then:
              - script.execute: script_intruder_alarm

    on_release:
      then:
        # Start the 5-minute timer to turn off the light
        # Only if one of the modes that turned it on is still active
        - if:
            condition:
              lambda: "return id(motionLightEnabled).state || id(is_security_mode);"
            then:
              - script.execute: light_off_timer

sensor:
  - platform: dht
    pin: GPIO13
    model: DHT11
    temperature:
      name: "Atal Tinkering Lab Temperature"
    humidity:
      name: "Atal Tinkering Lab Humidity"
    update_interval: 10s

# ─── SCRIPTS ───
script:
  - id: ring_short_bell
    then:
      - switch.turn_on: atalLabBell
      - delay: 3s
      - switch.turn_off: atalLabBell

  - id: ring_long_bell
    then:
      - switch.turn_on: atalLabBell
      - delay: 5s
      - switch.turn_off: atalLabBell

  - id: script_intruder_alarm
    mode: single
    then:
      - switch.turn_on: atalLabBell
      - delay: 1s
      - switch.turn_off: atalLabBell

  - id: light_off_timer
    mode: restart
    then:
      - delay: 5min
      - light.turn_off: atalLabLight

  - id: script_manual_siren
    mode: restart
    then:
      - if:
          condition:
            lambda: "return id(is_siren_running);"
          then:
            # STOP COMMAND
            - logger.log: "Siren stopping..."
            - script.stop: script_mock_drill
            - globals.set:
                id: is_siren_running
                value: "false"
            - switch.turn_off: atalLabBell
            - switch.turn_off: manualSirenSwitch
          else:
            # START COMMAND
            - globals.set:
                id: is_siren_running
                value: "true"
            - logger.log: "Starting Manual Siren..."
            - repeat:
                # ---------------------------------------------------------
                # LOGIC FIX: Combine Minutes AND Seconds
                # 1 Loop = 2 seconds (1s ON + 1s OFF)
                # Formula: Total Seconds / 2
                # ---------------------------------------------------------
                count: !lambda "return ((id(siren_duration).state * 60) + id(siren_duration_seconds).state) / 2;"
                then:
                  - switch.turn_on: atalLabBell
                  - delay: 1s
                  - switch.turn_off: atalLabBell
                  - delay: 1s
            # Cleanup after finishing
            - globals.set:
                id: is_siren_running
                value: "false"
            - switch.turn_off: manualSirenSwitch

  - id: script_mock_drill
    mode: restart
    then:
      - logger.log: "STARTING MONTHLY MOCK DRILL"
      - globals.set:
          id: is_siren_running
          value: "true"
      - repeat:
          count: 90
          then:
            - switch.turn_on: atalLabBell
            - delay: 1s
            - switch.turn_off: atalLabBell
            - delay: 1s
      - globals.set:
          id: is_siren_running
          value: "false"
      - switch.turn_off: manualSirenSwitch
      - logger.log: "MOCK DRILL COMPLETE"

# ─── TIME & SCHEDULES ───
time:
  - platform: sntp
    id: sntp_time
    timezone: Asia/Kolkata

    on_time:
      # ────────────────────────
      # 1. SECURITY MODE AUTO
      # ────────────────────────
      - seconds: 0
        minutes: 0
        hours: 21
        then:
          - switch.turn_on: securityModeSwitch

      - seconds: 0
        minutes: 0
        hours: 6
        then:
          - switch.turn_off: securityModeSwitch

      # ────────────────────────
      # 2. EXAM MODE SCHEDULE
      # ────────────────────────
      - seconds: 0
        minutes: 30
        hours: 8
        then:
          - if:
              condition:
                lambda: "return id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      - seconds: 0
        minutes: 45
        hours: 8
        then:
          - if:
              condition:
                lambda: "return id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      - seconds: 0
        minutes: 0
        hours: 9
        then:
          - if:
              condition:
                lambda: "return id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      - seconds: 0
        minutes: 0
        hours: 10
        then:
          - if:
              condition:
                lambda: "return id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 0
        hours: 11
        then:
          - if:
              condition:
                lambda: "return id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 55
        hours: 11
        then:
          - if:
              condition:
                lambda: "return id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      - seconds: 0
        minutes: 0
        hours: 12
        then:
          - if:
              condition:
                lambda: "return id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # ────────────────────────
      # 3. DEMO MODE
      # ────────────────────────
      - seconds: 0
        minutes: "*"
        hours: "*"
        days_of_week: "*"
        then:
          - if:
              condition:
                and:
                  - switch.is_on: demoMode
                  - lambda: "return id(sntp_time).now().minute % 2 == 0;"
              then:
                - script.execute: ring_short_bell

      # ────────────────────────
      # 4. MONTHLY MOCK DRILL
      # ────────────────────────
      - seconds: 0
        minutes: 50
        hours: 9
        days_of_month: "*"
        months: "*"
        days_of_week: "*"
        then:
          - if:
              condition:
                - switch.is_on: autoBell
                - lambda: "return !id(is_exam_mode);"
                - lambda: "return id(sntp_time).now().month != id(last_drill_month);"
              then:
                - if:
                    condition:
                      - lambda: "return random() % 30 == 12;"
                    then:
                      - globals.set:
                          id: last_drill_month
                          value: !lambda "return id(sntp_time).now().month;"
                      - delay: !lambda "return (random() % 240) * 60000;"
                      - script.execute: script_mock_drill

      # ────────────────────────
      # 5. WINTER TIMINGS
      # ────────────────────────
      # 8:15 AM
      - seconds: 0
        minutes: 15
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # 8:20 AM
      - seconds: 0
        minutes: 20
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # 8:25 AM
      - seconds: 0
        minutes: 25
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # 8:30 AM
      - seconds: 0
        minutes: 30
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # 8:45 AM
      - seconds: 0
        minutes: 45
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # 9:00 AM
      - seconds: 0
        minutes: 0
        hours: 9
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 9:35 AM
      - seconds: 0
        minutes: 35
        hours: 9
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 10:10 AM
      - seconds: 0
        minutes: 10
        hours: 10
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 10:45 AM
      - seconds: 0
        minutes: 45
        hours: 10
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 11:25 AM
      - seconds: 0
        minutes: 25
        hours: 11
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # 11:50 AM
      - seconds: 0
        minutes: 50
        hours: 11
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # 12:00 PM
      - seconds: 0
        minutes: 0
        hours: 12
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 12:40 PM
      - seconds: 0
        minutes: 40
        hours: 12
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 1:20 PM
      - seconds: 0
        minutes: 20
        hours: 13
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 2:00 PM
      - seconds: 0
        minutes: 0
        hours: 14
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 2:40 PM
      - seconds: 0
        minutes: 40
        hours: 14
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_on: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # ────────────────────────
      # 6. SUMMER TIMINGS
      # ────────────────────────
      # 7:55 AM (Summer Long)
      - seconds: 0
        minutes: 55
        hours: 7
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # 10:55 AM (Summer Long)
      - seconds: 0
        minutes: 55
        hours: 10
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # 2:10 PM (Summer Long)
      - seconds: 0
        minutes: 10
        hours: 14
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_long_bell

      # 8:15 AM (Summer Short)
      - seconds: 0
        minutes: 15
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 8:55 AM (Summer Short)
      - seconds: 0
        minutes: 55
        hours: 8
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 9:35 AM (Summer Short)
      - seconds: 0
        minutes: 35
        hours: 9
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 10:15 AM (Summer Short)
      - seconds: 0
        minutes: 15
        hours: 10
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 11:25 AM (Summer Short)
      - seconds: 0
        minutes: 25
        hours: 11
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 11:30 AM (Summer Short)
      - seconds: 0
        minutes: 30
        hours: 11
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 12:10 PM (Summer Short)
      - seconds: 0
        minutes: 10
        hours: 12
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 12:50 PM (Summer Short)
      - seconds: 0
        minutes: 50
        hours: 12
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

      # 1:30 PM (Summer Short)
      - seconds: 0
        minutes: 30
        hours: 13
        days_of_week: [2, 3, 4, 5, 6, 7]
        then:
          - if:
              condition:
                and:
                  - switch.is_on: autoBell
                  - switch.is_off: winterMode
                  - lambda: "return !id(is_exam_mode);"
              then:
                - script.execute: ring_short_bell

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  min_auth_mode: WPA2
  fast_connect: true
